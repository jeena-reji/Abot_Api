name: Update Submodules

on:
  push:
    branches:
      - main   # ðŸ‘ˆ You can change this branch if needed (e.g., 'develop')

jobs:
  update_submodules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'true'
          fetch-depth: 0
          token: ${{ secrets.AUTO_TOKEN }}

      - name: Set default inputs manually
        id: default_inputs
        run: |
          # ðŸ‘‡ Set your default values here
          SELECT_ALL="yes"  # options: yes / no
          SUBMODULES_TO_UPDATE="ausf amf"  # ignored if SELECT_ALL=yes
          CUSTOM_VERSIONS="upf@c20c505 amf@v1.0.0"  # leave empty if not needed

          echo "select_all=$SELECT_ALL" >> $GITHUB_OUTPUT
          echo "submodules_to_update=$SUBMODULES_TO_UPDATE" >> $GITHUB_OUTPUT
          echo "custom_versions=$CUSTOM_VERSIONS" >> $GITHUB_OUTPUT

      - name: Determine Submodules to Update
        id: get_submodules
        run: |
          if [[ "${{ steps.default_inputs.outputs.select_all }}" == "yes" ]]; then
            SUBMODULES=$(git config --file .gitmodules --get-regexp path | awk '{ print $2 }')
          else
            SUBMODULES="${{ steps.default_inputs.outputs.submodules_to_update }}"
          fi
          SUBMODULES=$(echo "$SUBMODULES" | xargs)
          echo "Updating submodules: $SUBMODULES"
          echo "submodules=$SUBMODULES" >> $GITHUB_OUTPUT
          echo "custom_versions=${{ steps.default_inputs.outputs.custom_versions }}" >> $GITHUB_OUTPUT

      - name: Debug Submodule State
        run: |
          echo "Submodule status before update:"
          git submodule foreach 'echo "$(git rev-parse HEAD) $name"'
          echo "Submodule logs:"
          git submodule foreach 'git log -1'

      - name: Set up Git with PAT for authentication
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update selected submodules
        run: |
          INPUT_SUBMODULES="${{ steps.get_submodules.outputs.submodules }}"
          CUSTOM_VERSIONS="${{ steps.get_submodules.outputs.custom_versions }}"

          declare -A VERSION_MAP
          for entry in $CUSTOM_VERSIONS; do
            submodule="${entry%@*}"
            version="${entry#*@}"
            VERSION_MAP[$submodule]=$version
          done

          for submodule in $INPUT_SUBMODULES; do
            if [ -d "$submodule" ]; then
              echo "Updating submodule: $submodule"
              cd "$submodule"
              git fetch origin +refs/heads/*:refs/remotes/origin/* --tags
              if [[ -n "${VERSION_MAP[$submodule]}" ]]; then
                echo "â†’ Pinned to ${VERSION_MAP[$submodule]}"
                git checkout "${VERSION_MAP[$submodule]}" || { echo "Failed to checkout ${VERSION_MAP[$submodule]} in $submodule"; }
              else
                DEFAULT_BRANCH=$(git remote show origin | sed -n "/HEAD branch/s/.*: //p")
                echo "â†’ Default branch: $DEFAULT_BRANCH"
                git checkout $DEFAULT_BRANCH
                git reset --hard origin/$DEFAULT_BRANCH
              fi
              cd - >/dev/null
            else
              echo "Submodule $submodule not found. Skipping..."
            fi
          done

      - name: Commit and push submodule updates
        run: |
          git fetch origin main
          git rebase origin/main || echo "Rebase failed, maybe on a different branch"
          git add .gitmodules
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit, submodules are already up-to-date."
          else
            echo "Changes detected. Committing..."
            git commit -m "Auto-update submodules (with overrides if specified)" || echo "No commit created"
            git push origin main || echo "Push failed (maybe on a different branch)"
          fi

      - name: Debug Final State
        run: |
          echo "Final submodule state:"
          git submodule foreach 'echo "$(git rev-parse HEAD) $name"'
